    }
  });

  // ============================================
  // SUBJECT-BASED EDUCATION API (Primary/Secondary)
  // ============================================

  // Get subjects filtered by grade level and system (for primary/secondary students)
  app.get("/api/subjects", async (req, res) => {
    try {
      const { gradeLevel, gradeSystem, creatorOnly } = req.query;
      const user = req.user as any;
      const isAdmin = user?.role === "admin";
      
      let conditions: any[] = [eq(subjects.isActive, true)];

      if (creatorOnly === "true" && req.isAuthenticated()) {
        conditions = [eq(subjects.createdBy, user.id)];
      } else if (isAdmin && creatorOnly === "false") {
        conditions = [];
      } else {
        if (gradeLevel) {
          const parsedGrade = parseInt(gradeLevel as string);
          conditions.push(eq(subjects.gradeLevel, parsedGrade));
        }
        
        if (gradeSystem && gradeSystem !== "undefined" && gradeSystem !== "null") {
          conditions.push(or(
            eq(subjects.gradeSystem, gradeSystem as string),
            eq(subjects.gradeSystem, "all")
          ));
        } else {
          conditions.push(eq(subjects.gradeSystem, "all"));
        }
      }
      
      const subjectsData = await db
        .select()
        .from(subjects)
        .where(conditions.length > 0 ? and(...conditions) : undefined)
        .orderBy(subjects.name);
      
      res.json({ success: true, data: subjectsData });
    } catch (error: any) {
      console.error("Subjects fetch error:", error);
      res.status(500).json({ success: false, error: "Failed to fetch subjects" });
    }
  });

  // Get lessons for a specific chapter
  app.get("/api/chapters/:chapterId/lessons", async (req, res) => {
    }
  });

  // ============================================
  // POST ENDPOINTS FOR SUBJECT-BASED EDUCATION
  // ============================================

  // Create a new subject
  app.post("/api/subjects", async (req, res) => {
    try {
      const { name, gradeSystem, gradeLevel, description, iconUrl } = req.body;
      
      if (!name || !gradeSystem || !gradeLevel) {
        return res.status(400).json({ 
          success: false, 
          error: "Missing required fields" 
        });
      }
      
      const newSubject = await db
        .insert(subjects)
        .values({
          name,
          gradeSystem,
          gradeLevel: parseInt(gradeLevel),
          description: description || null,
          iconUrl: iconUrl || null,
          createdBy: (req.user as any).id,
          isActive: true
        })
        .returning();
      
      res.json({ success: true, data: newSubject[0] });
    } catch (error: any) {
      console.error("Subject creation error:", error);
      res.status(500).json({ success: false, error: "Failed to create subject" });
    }
  });

  // Delete a subject and all its related data
  app.delete("/api/subjects/:subjectId", async (req, res) => {
    try {
      const { subjectId } = req.params;
      
      // Get all chapters for this subject
      const chaptersToDelete = await db
